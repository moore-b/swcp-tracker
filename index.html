<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SW Coast Path Tracker</title>
   
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js' defer></script>
    <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        #map, .activity-map { border-radius: 0.5rem; background-color: #f3f4f6; }
        #map { height: 400px; width: 100%; }
        .activity-map { height: 200px; width: 100%; }
        .btn-strava { background-color: #FC5200; }
        .btn-strava:hover { background-color: #e04a00; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
            display: inline-block; margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { cursor: pointer; list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before { content: 'â–¶'; margin-right: 0.5rem; display: inline-block; transition: transform 0.2s; }
        details[open] > summary::before { transform: rotate(90deg); }
        .filter-btn { padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #ffffff; transition: background-color 0.2s; }
        .filter-btn:hover { background-color: #f3f4f6; }
        .filter-btn.active { background-color: #3b82f6; color: #ffffff; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="flex justify-between items-center mb-8">
            <div class="text-left">
                <h1 class="text-4xl font-bold text-gray-900">SW Coast Path Tracker</h1>
                <p class="mt-2 text-lg text-gray-600">Log your progress on the 630-mile journey.</p>
            </div>
            <button id="logout-button" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Logout</button>
        </header>

        <main id="main-content">
            <div id="auth-section" class="hidden bg-white p-6 rounded-lg shadow-md mb-8">
                <div id="auth-container"></div>
            </div>
           
            <div id="strava-connect-section" class="hidden bg-white p-6 rounded-lg shadow-md mb-8 text-center">
                <h2 class="text-2xl font-semibold mb-4">Almost there!</h2>
                <p class="text-gray-600 mb-6">You are logged in. Now, connect to Strava to fetch your activities and track your progress.</p>
                <button id="strava-connect-button" class="btn-strava text-white font-bold py-3 px-4 rounded-lg">Connect with Strava</button>
            </div>

            <div id="app-content" class="hidden">
                <div id="progress-section" class="bg-white p-6 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-4 border-b pb-3">
                         <h2 class="text-2xl font-semibold">Overall Progress</h2>
                         <div id="strava-user-info" class="text-right"></div>
                    </div>
                    <div class="mb-6">
                        <p class="text-lg">Completion: <span id="progress-percentage" class="font-bold text-blue-600">0.00%</span></p>
                        <p class="text-sm text-gray-500">Distance: <span id="completed-distance">0.00</span> km / <span id="total-distance">0.00</span> km</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-2"><div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    </div>
                    <h3 class="text-xl font-semibold mb-3">Master Map</h3>
                    <div id="map"></div>
                    <div class="text-right mt-2"><button id="reset-button" class="text-sm text-red-600 hover:underline">Reset All Progress</button></div>
                </div>

                <div id="activity-list-section" class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Your Walks & Hikes <span id="activity-count" class="text-lg font-normal text-gray-500"></span></h2>
                        <div id="filter-buttons" class="flex space-x-2">
                            <button data-filter="all" class="filter-btn active">All</button>
                            <button data-filter="Walk" class="filter-btn">Walks</button>
                            <button data-filter="Hike" class="filter-btn">Hikes</button>
                        </div>
                    </div>
                    <div id="activity-list-container" class="space-y-4"></div>
                </div>
            </div>

            <div id="status-log-section" class="mt-8">
                <details><summary class="text-xl font-semibold mb-2">Status Log</summary><div id="status-log" class="bg-gray-900 text-white font-mono text-sm rounded-lg p-4 h-48 overflow-y-auto"></div></details>
            </div>
        </main>
    </div>

    <template id="activity-card-template">
        <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
             <div class="flex justify-between items-start">
                <div><h3 class="font-bold text-lg" data-name></h3><p class="text-sm text-gray-500 mb-2" data-date></p></div>
                <span data-type class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200 ml-2"></span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><div class="activity-map" data-map-id></div></div>
                <div>
                    <ul class="text-sm space-y-1"><li data-distance></li><li data-time></li><li data-elevation></li></ul>
                    <div class="mt-4 space-y-2">
                        <button data-analyze-btn class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-3 rounded-lg transition disabled:bg-gray-300">Analyze</button>
                        <button data-update-btn class="w-full bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-2 px-3 rounded-lg transition">Update Title</button>
                    </div>
                </div>
            </div>
        </div>
    </template>
   
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const SWCP_GEOJSON_URL = 'routes.geojson';
            const DISTANCE_THRESHOLD_METERS = 100;
           
            const UIElements = {
                authSection: document.getElementById('auth-section'),
                authContainer: document.getElementById('auth-container'),
                stravaConnectSection: document.getElementById('strava-connect-section'),
                stravaConnectButton: document.getElementById('strava-connect-button'),
                appContent: document.getElementById('app-content'),
                logoutButton: document.getElementById('logout-button'),
                activityListContainer: document.getElementById('activity-list-container'),
                activityCardTemplate: document.getElementById('activity-card-template'),
                activityCount: document.getElementById('activity-count'),
                filterButtons: document.getElementById('filter-buttons'),
                resetButton: document.getElementById('reset-button'),
                statusLog: document.getElementById('status-log'),
                stravaUserInfo: document.getElementById('strava-user-info'),
                progressBar: document.getElementById('progress-bar'),
                progressPercentage: document.getElementById('progress-percentage'),
                completedDistance: document.getElementById('completed-distance'),
                totalDistance: document.getElementById('total-distance'),
                mainMap: document.getElementById('map'),
            };

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let mainMap, swcpGeoJSON, swcpTotalDistance = 0, completedSegmentsLayer, currentPercentage = 0, allFetchedActivities = [];
            let userId = null;
            let progressDocRef = null;
            let userProgress = { completedPoints: [], processedIds: [] };
            let unsubscribe;

            const log = (message, type = 'info') => {
                const now = new Date().toLocaleTimeString();
                UIElements.statusLog.innerHTML += `<p><span class="text-gray-500">${now}:</span> <span class="${type === 'error' ? 'text-red-400' : 'text-green-400'}">${message}</span></p>`;
                UIElements.statusLog.scrollTop = UIElements.statusLog.scrollHeight;
                if (type === 'error') console.error(message);
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
           
            const renderAuthForm = (isLogin = true) => {
                const stravaFields = `
                    <div class="mt-4 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Strava API Credentials</h3>
                        <div><label for="stravaClientId" class="block text-sm font-medium">Client ID</label><input type="text" id="stravaClientId" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm"></div>
                        <div class="mt-2"><label for="stravaClientSecret" class="block text-sm font-medium">Client Secret</label><input type="password" id="stravaClientSecret" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm"></div>
                    </div>`;
                UIElements.authContainer.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">${isLogin ? 'Login' : 'Register'}</h2>
                    <div><label for="email" class="block text-sm font-medium">Email</label><input type="email" id="email" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm"></div>
                    <div class="mt-2"><label for="password" class="block text-sm font-medium">Password</label><input type="password" id="password" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm"></div>
                    ${isLogin ? '' : stravaFields}
                    <button id="auth-submit-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">${isLogin ? 'Login' : 'Register'}</button>
                    <p class="mt-4 text-center text-sm">${isLogin ? "Don't have an account?" : "Already have an account?"} <button id="auth-toggle-button" class="font-medium text-blue-600 hover:underline">${isLogin ? 'Register' : 'Login'}</button></p>`;
                document.getElementById('auth-submit-button').onclick = isLogin ? handleLogin : handleRegister;
                document.getElementById('auth-toggle-button').onclick = () => renderAuthForm(!isLogin);
            };

            const handleRegister = async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const clientId = document.getElementById('stravaClientId').value;
                const clientSecret = document.getElementById('stravaClientSecret').value;
                if (!email || !password || !clientId || !clientSecret) { log('All fields are required.', 'error'); return; }
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    log(`User registered: ${user.uid}`, 'success');
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const credentialsDocRef = doc(db, "artifacts", appId, "users", user.uid, "credentials", "strava");
                    await setDoc(credentialsDocRef, { clientId: btoa(clientId), clientSecret: btoa(clientSecret) });
                    log('Credentials saved.', 'success');
                } catch (error) { log(`Registration failed: ${error.message}`, 'error'); }
            };
           
            const handleLogin = async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { log(`Login failed: ${error.message}`, 'error'); }
            };

            const handleLogout = async () => {
                if (unsubscribe) unsubscribe();
                await signOut(auth);
                sessionStorage.clear();
                log('Logged out.');
            };

            async function getAccessToken(code) {
                log('Exchanging authorization code for access token...');
                try {
                    const response = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: sessionStorage.getItem('stravaClientId'),
                            client_secret: sessionStorage.getItem('stravaClientSecret'),
                            code: code, grant_type: 'authorization_code'
                        }),
                    });
                    const data = await response.json();
                    if (data.access_token) {
                        log('Success! Strava Access Token received.', 'success');
                        sessionStorage.setItem('stravaAccessToken', data.access_token);
                        sessionStorage.setItem('stravaAthlete', JSON.stringify(data.athlete));
                        window.history.pushState({}, document.title, window.location.pathname);
                    } else { log(`Error getting Strava access token: ${data.message}`, 'error'); }
                } catch (error) { log(`Network error during token exchange: ${error.message}`, 'error'); }
            }
           
            async function showMainApp() {
                const athlete = JSON.parse(sessionStorage.getItem('stravaAthlete') || '{}');
                if(athlete.firstname) UIElements.stravaUserInfo.innerHTML = `<p class="font-semibold">${athlete.firstname} ${athlete.lastname}</p>`;
               
                await initializeMap();
                allFetchedActivities = await fetchAllActivities();
                if (allFetchedActivities) renderActivityList(allFetchedActivities);
            }

            async function initializeMap() {
                 if (mainMap) return;
                 mainMap = L.map(UIElements.mainMap).setView([50.5, -4.0], 7);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(mainMap);
                 completedSegmentsLayer = L.layerGroup().addTo(mainMap);
                 try {
                     const response = await fetch(SWCP_GEOJSON_URL);
                     if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                     const data = await response.json();
                     if (!data.features || data.features.length === 0) throw new Error('GeoJSON file is empty.');
                     swcpTotalDistance = 0;
                     const allCoordinates = data.features.reduce((coords, feature) => {
                         swcpTotalDistance += turf.length(feature, { units: 'kilometers' });
                         return coords.concat(feature.geometry.coordinates);
                     }, []);
                     swcpGeoJSON = turf.lineString(allCoordinates).geometry;
                     const leafletGeoJson = L.geoJSON(data, { style: { color: 'blue', weight: 3, opacity: 0.7 } }).addTo(mainMap);
                     mainMap.fitBounds(leafletGeoJson.getBounds());
                     UIElements.totalDistance.textContent = swcpTotalDistance.toFixed(2);
                     log('Master map loaded.', 'success');
                 } catch(e) { log(`Failed to load map data: ${e.message}`, 'error'); }
            }

            function connectToStrava() {
                const clientId = sessionStorage.getItem('stravaClientId');
                if(!clientId) { log('Could not find Strava Client ID.', 'error'); return; }
                const redirectUri = window.location.origin + window.location.pathname;
                window.location.href = `https://www.strava.com/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=read,activity:read_all,activity:write`;
            }

            function resetProgress() {
                if (confirm("Are you sure? This will delete your progress from the cloud.")) {
                    setDoc(progressDocRef, { completedPoints: [], processedIds: [] });
                }
            }

            function handleFilterClick(e) {
                if (e.target.tagName !== 'BUTTON') return;
                const filter = e.target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderActivityList(filter === 'all' ? allFetchedActivities : allFetchedActivities.filter(act => act.type === filter));
            }

            function renderActivityList(activities) {
                UIElements.activityListContainer.innerHTML = '';
                UIElements.activityCount.textContent = `(${activities.length} found)`;
                const processedIds = new Set(userProgress.processedIds || []);
                activities.forEach(activity => {
                    const card = UIElements.activityCardTemplate.content.cloneNode(true);
                    const cardDiv = card.querySelector('.bg-white');
                    const nameEl = cardDiv.querySelector('[data-name]');
                    nameEl.textContent = activity.name;
                    const typeEl = cardDiv.querySelector('[data-type]');
                    typeEl.textContent = activity.type;
                    typeEl.className = `text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${activity.type === 'Hike' ? 'text-emerald-600 bg-emerald-200' : 'text-sky-600 bg-sky-200'} ml-2`;
                    cardDiv.querySelector('[data-date]').textContent = new Date(activity.start_date).toLocaleDateString();
                    cardDiv.querySelector('[data-distance]').innerHTML = `<strong>Distance:</strong> ${(activity.distance / 1000).toFixed(2)} km`;
                    cardDiv.querySelector('[data-time]').innerHTML = `<strong>Moving Time:</strong> ${new Date(activity.moving_time * 1000).toISOString().substr(11, 8)}`;
                    cardDiv.querySelector('[data-elevation]').innerHTML = `<strong>Elevation Gain:</strong> ${activity.total_elevation_gain.toFixed(0)} m`;
                    const mapEl = cardDiv.querySelector('[data-map-id]');
                    mapEl.id = `map-${activity.id}`;
                    const analyzeBtn = cardDiv.querySelector('[data-analyze-btn]');
                    if (processedIds.has(activity.id)) { analyzeBtn.textContent = 'Analyzed'; analyzeBtn.disabled = true; }
                    else { analyzeBtn.onclick = () => analyzeSingleActivity(activity, analyzeBtn); }
                    cardDiv.querySelector('[data-update-btn]').onclick = () => updateSingleTitle(activity, cardDiv.querySelector('[data-update-btn]'), nameEl);
                    UIElements.activityListContainer.appendChild(card);
                    if(activity.map.summary_polyline) {
                        const latlngs = polyline.decode(activity.map.summary_polyline);
                        if (latlngs.length > 0) {
                            const activityMap = L.map(mapEl.id, { scrollWheelZoom: false }).setView(latlngs[0], 13);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(activityMap);
                            const activityLine = L.polyline(latlngs, {color: '#FC5200'}).addTo(activityMap);
                            setTimeout(() => activityMap.fitBounds(activityLine.getBounds()), 1);
                        }
                    }
                });
            }

            async function analyzeSingleActivity(activity, button) {
                button.disabled = true; button.innerHTML = `<span class="loader"></span>Analyzing...`;
                const stream = await getActivityStream(activity.id);
                let newlyCompletedPoints = [];
                if (stream) {
                    const activityLine = turf.lineString(stream.map(p => [p[1], p[0]]));
                    newlyCompletedPoints = findOverlappingPoints(activityLine);
                    log(`-> Found ${newlyCompletedPoints.length} matching points for "${activity.name}".`, 'success');
                }
                const currentProgress = { completedPoints: [...(userProgress.completedPoints || []), ...newlyCompletedPoints], processedIds: [...(userProgress.processedIds || []), activity.id] };
                await setDoc(progressDocRef, currentProgress);
                log('Progress saved to the cloud.', 'success');
                button.textContent = 'Analyzed';
            }

            async function updateSingleTitle(activity, button, nameEl) {
                button.disabled = true; button.innerHTML = `<span class="loader"></span>Updating...`;
                const cleanName = activity.name.replace(/SWCP \d+\.\d+% \| /g, '');
                const newTitle = `SWCP ${currentPercentage}% | ${cleanName}`;
                if (activity.name !== newTitle) {
                    await updateActivity(activity.id, newTitle);
                    nameEl.textContent = newTitle;
                    activity.name = newTitle;
                }
                button.textContent = 'Updated'; setTimeout(() => { button.textContent = 'Update Title'; button.disabled = false; }, 2000);
            }

            async function updateActivity(id, newTitle) {
                const accessToken = sessionStorage.getItem('stravaAccessToken');
                await fetch(`https://www.strava.com/api/v3/activities/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` }, body: JSON.stringify({ name: newTitle }) });
            }

            async function fetchAllActivities() {
                const accessToken = sessionStorage.getItem('stravaAccessToken');
                let allActivities = [];
                for (let page = 1; page < 10; page++) {
                    const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?page=${page}&per_page=100`, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                    if (!response.ok) { log('Failed to fetch activities', 'error'); return null; }
                    const activities = await response.json();
                    if (activities.length === 0) break;
                    allActivities.push(...activities);
                }
                return allActivities.filter(a => ['Walk', 'Hike'].includes(a.type));
            }

            async function getActivityStream(activityId) {
                const accessToken = sessionStorage.getItem('stravaAccessToken');
                const response = await fetch(`https://www.strava.com/api/v3/activities/${activityId}/streams?keys=latlng&key_by_type=true`, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                return response.ok ? (await response.json()).latlng?.data : null;
            }
           
            function findOverlappingPoints(activityLine) {
                const matchedPoints = [];
                if (!swcpGeoJSON) return [];
                for (const pointCoords of activityLine.geometry.coordinates) {
                     const point = turf.point(pointCoords);
                     const nearestPointOnLine = turf.nearestPointOnLine(swcpGeoJSON, point, {units: 'meters'});
                     if (turf.distance(point, nearestPointOnLine, {units: 'meters'}) < DISTANCE_THRESHOLD_METERS) matchedPoints.push(nearestPointOnLine.geometry.coordinates);
                }
                return matchedPoints;
            }

            function updateProgress(completedPoints) {
                if (completedSegmentsLayer) completedSegmentsLayer.clearLayers();
                let totalCompletedDistance = 0;
                if (completedPoints && completedPoints.length > 1) {
                    const uniquePoints = completedPoints.reduce((acc, point) => {
                        if (!acc.some(p => turf.distance(turf.point(p), turf.point(point), {units: 'kilometers'}) < 0.02)) acc.push(point);
                        return acc;
                    }, []);
                    uniquePoints.sort((a, b) => turf.nearestPointOnLine(swcpGeoJSON, a).properties.location - turf.nearestPointOnLine(swcpGeoJSON, b).properties.location);
                    if (uniquePoints.length > 1) {
                        const completedLine = turf.lineString(uniquePoints);
                        totalCompletedDistance = turf.length(completedLine, { units: 'kilometers' });
                        L.geoJSON(completedLine, { style: { color: 'green', weight: 5, opacity: 0.8 } }).addTo(completedSegmentsLayer);
                    }
                }
                currentPercentage = swcpTotalDistance > 0 ? ((totalCompletedDistance / swcpTotalDistance) * 100).toFixed(2) : 0;
                UIElements.completedDistance.textContent = totalCompletedDistance.toFixed(2);
                UIElements.progressPercentage.textContent = `${currentPercentage}%`;
                UIElements.progressBar.style.width = `${currentPercentage}%`;
            }

            // ** NEW, SIMPLIFIED STARTUP LOGIC **
            UIElements.logoutButton.addEventListener('click', handleLogout);
            UIElements.filterButtons.addEventListener('click', handleFilterClick);
            UIElements.resetButton.addEventListener('click', resetProgress);
            UIElements.stravaConnectButton.addEventListener('click', connectToStrava);

            onAuthStateChanged(auth, async (user) => {
                // Hide all main sections by default on any auth change
                UIElements.authSection.style.display = 'none';
                UIElements.stravaConnectSection.style.display = 'none';
                UIElements.appContent.style.display = 'none';
                UIElements.logoutButton.style.display = 'none';
               
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get('code');

                if (user) {
                    userId = user.uid;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    progressDocRef = doc(db, "artifacts", appId, "users", userId, "swcp_progress", "main");
                    const credentialsDocRef = doc(db, "artifacts", appId, "users", userId, "credentials", "strava");
                   
                    if (unsubscribe) unsubscribe();
                    unsubscribe = onSnapshot(progressDocRef, (doc) => {
                        userProgress = doc.exists() ? doc.data() : { completedPoints: [], processedIds: [] };
                        log('Cloud progress data loaded/updated.');
                        if (swcpGeoJSON) updateProgress(userProgress.completedPoints || []);
                    });
                   
                    const credDoc = await getDoc(credentialsDocRef);
                    if (credDoc.exists()) {
                        const creds = credDoc.data();
                        sessionStorage.setItem('stravaClientId', atob(creds.clientId));
                        sessionStorage.setItem('stravaClientSecret', atob(creds.clientSecret));
                    } else {
                        log('FATAL: Strava credentials not found in your account!', 'error');
                        handleLogout();
                        return;
                    }

                    UIElements.logoutButton.style.display = 'block';

                    if (authCode) {
                        await getAccessToken(authCode);
                        // The onAuthStateChanged will re-fire after the page reloads from getAccessToken
                        return;
                    }

                    if (sessionStorage.getItem('stravaAccessToken')) {
                        UIElements.appContent.style.display = 'block';
                        await showMainApp();
                    } else {
                        UIElements.stravaConnectSection.style.display = 'block';
                    }
                } else {
                    // Not logged in
                    UIElements.authSection.style.display = 'block';
                    renderAuthForm();
                }
            });
        });
    </script>
</body>
</html>
