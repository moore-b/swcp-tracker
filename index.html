<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SW Coast Path Tracker</title>
   
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Leaflet.js for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
   
    <!-- GPX parsing library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gpx-parse/0.10.3/gpx-parse.min.js"></script>

    <style>
        /* Custom styles for a better look */
        body {
            font-family: 'Inter', sans-serif; /* Using a Google Font, loaded via Tailwind config */
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .leaflet-control-zoom {
            border: 1px solid #ccc !important;
        }
        .btn-strava {
            background-color: #FC5200; /* Strava Orange */
        }
        .btn-strava:hover {
            background-color: #e04a00;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
       
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">South West Coast Path Tracker</h1>
            <p class="mt-2 text-lg text-gray-600">Log your progress on the 630-mile journey.</p>
        </header>

        <main id="main-content">
           
            <!-- Step 1: Configuration and Connection -->
            <div id="config-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">1. Connect to Strava</h2>
                <p class="text-gray-600 mb-4">
                    Enter your Strava API details below. You can get these from your <a href="https://www.strava.com/settings/api" target="_blank" class="text-blue-600 hover:underline">Strava API settings page</a>.
                    This information is only stored in your browser and is not sent anywhere else.
                </p>
                <div class="space-y-4">
                    <div>
                        <label for="clientId" class="block text-sm font-medium text-gray-700">Client ID</label>
                        <input type="text" id="clientId" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="clientSecret" class="block text-sm font-medium text-gray-700">Client Secret</label>
                        <input type="password" id="clientSecret" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button id="connect-button" class="mt-6 w-full btn-strava text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Connect with Strava
                </button>
            </div>

            <!-- Step 2: Progress Display (Initially Hidden) -->
            <div id="progress-section" class="hidden bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                     <h2 class="text-2xl font-semibold">2. Your Progress</h2>
                     <div id="strava-user-info" class="text-right"></div>
                </div>
               
                <div class="mb-6">
                    <p class="text-lg">Overall Completion: <span id="progress-percentage" class="font-bold text-blue-600">0%</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                        <div id="progress-bar" class="bg-blue-600 h-4 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <h3 class="text-xl font-semibold mb-3">Map of the Path</h3>
                <div id="map"></div>
                 <button id="analyze-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Analyze My Strava Activities
                </button>
            </div>

            <!-- Status Log -->
            <div id="status-log-section" class="mt-8">
                <h3 class="text-xl font-semibold mb-2">Status Log</h3>
                <div id="status-log" class="bg-gray-900 text-white font-mono text-sm rounded-lg p-4 h-48 overflow-y-auto">
                    <p>Welcome! Please enter your API details to begin.</p>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        // This is the URL of the official GPX file for the South West Coast Path.
        // I found this via the National Trails website. It's a large file, so it might take a moment to load.
        // To avoid issues with cross-origin requests (CORS), we're using a CORS proxy.
        const SWCP_GPX_URL = 'https://api.allorigins.win/raw?url=https://www.nationaltrail.co.uk/fs/i/gpx/south-west-coast-path.gpx';
       
        // --- DOM ELEMENTS ---
        const clientIdInput = document.getElementById('clientId');
        const clientSecretInput = document.getElementById('clientSecret');
        const connectButton = document.getElementById('connect-button');
        const configSection = document.getElementById('config-section');
        const progressSection = document.getElementById('progress-section');
        const analyzeButton = document.getElementById('analyze-button');
        const statusLog = document.getElementById('status-log');
        const stravaUserInfo = document.getElementById('strava-user-info');

        let map; // To hold the map instance
        let swcpPolyline; // To hold the path layer on the map
       
        // --- LOGGING FUNCTION ---
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-gray-300');
            statusLog.innerHTML += `<p><span class="text-gray-500">${now}:</span> <span class="${color}">${message}</span></p>`;
            statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll to bottom
        }

        // --- CORE LOGIC ---

        // This function runs as soon as the page loads.
        window.onload = async () => {
            log('Page loaded. Ready for action.');

            // Check if Client ID and Secret are already in browser's session storage
            clientIdInput.value = sessionStorage.getItem('stravaClientId') || '';
            clientSecretInput.value = sessionStorage.getItem('stravaClientSecret') || '';
            checkInputs();

            // Part 2 of the login flow: Check if the URL has a "code" from Strava.
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');

            if (authCode) {
                log('Authorization code found in URL. Attempting to get access token.');
                await getAccessToken(authCode);
            }
           
            // If we have an access token (either new or from a previous session), show the progress section.
            if (sessionStorage.getItem('stravaAccessToken')) {
                log('Existing access token found. Showing progress section.');
                showProgressSection();
            } else {
                log('No access token. Waiting for user to connect.');
            }
        };

        // Enable the connect button only when both fields have text.
        function checkInputs() {
            if (clientIdInput.value.trim() !== '' && clientSecretInput.value.trim() !== '') {
                connectButton.disabled = false;
            } else {
                connectButton.disabled = true;
            }
        }
        clientIdInput.addEventListener('input', checkInputs);
        clientSecretInput.addEventListener('input', checkInputs);
       
        // --- STRAVA AUTHENTICATION ---
       
        // Step 1: Redirect user to Strava to grant permission.
        connectButton.addEventListener('click', () => {
            log('Connect button clicked. Redirecting to Strava for authorization...');
           
            const clientId = clientIdInput.value.trim();
            const clientSecret = clientSecretInput.value.trim();
           
            // Store the ID and Secret in the browser's session storage.
            // This way, you don't have to re-enter them if you refresh the page.
            sessionStorage.setItem('stravaClientId', clientId);
            sessionStorage.setItem('stravaClientSecret', clientSecret);

            // This is the URL of our own page. Strava will send the user back here.
            // For local testing, 'http://127.0.0.1:5500/index.html' or similar is fine if you use a Live Server.
            // When you deploy to Render, you will need to change this!
            const redirectUri = window.location.origin + window.location.pathname;

            // These are the permissions we're asking for.
            // activity:read_all lets us see all your activities.
            // activity:write lets us update the titles later.
            const scope = 'read,activity:read_all,activity:write';

            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}`;
           
            window.location.href = authUrl;
        });

        // Step 2: Exchange the auth code for an access token.
        async function getAccessToken(code) {
            const clientId = sessionStorage.getItem('stravaClientId');
            const clientSecret = sessionStorage.getItem('stravaClientSecret');

            if (!clientId || !clientSecret) {
                log('Error: Client ID or Secret not found in session storage. Please enter them again.', 'error');
                return;
            }

            // We have to send a POST request to Strava's token endpoint.
            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret,
                        code: code,
                        grant_type: 'authorization_code',
                    }),
                });

                const data = await response.json();

                if (data.access_token) {
                    log('Success! Access Token received.', 'success');
                    sessionStorage.setItem('stravaAccessToken', data.access_token);
                    sessionStorage.setItem('stravaRefreshToken', data.refresh_token);
                    sessionStorage.setItem('stravaAthlete', JSON.stringify(data.athlete));
                   
                    // Clean the code from the URL and reload to a clean state
                    window.location.href = window.location.pathname;
                } else {
                    log(`Error getting access token: ${data.message}`, 'error');
                    console.error(data);
                }
            } catch (error) {
                log(`A network error occurred: ${error.message}`, 'error');
                console.error(error);
            }
        }
       
        // --- UI AND MAP LOGIC ---

        // This function hides the config and shows the main progress view.
        function showProgressSection() {
            configSection.style.display = 'none';
            progressSection.style.display = 'block';

            // Display user info
            const athlete = JSON.parse(sessionStorage.getItem('stravaAthlete'));
            if(athlete) {
                stravaUserInfo.innerHTML = `
                    <p class="font-semibold">${athlete.firstname} ${athlete.lastname}</p>
                    <p class="text-sm text-gray-500">${athlete.city}, ${athlete.country}</p>
                `;
            }

            initializeMap();
        }

        // Sets up the Leaflet map and loads the SWCP path.
        async function initializeMap() {
            log('Initializing map...');
            // Create a map centered roughly on the South West.
            map = L.map('map').setView([50.5, -4.0], 8);

            // Add a tile layer from OpenStreetMap.
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            log('Map initialized. Fetching SWCP route data...');
           
            try {
                const response = await fetch(SWCP_GPX_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const gpxData = await response.text();
               
                log('Route data received. Parsing GPX file...', 'success');
               
                // Use the gpx-parse library to convert the GPX text into a usable object.
                gpxParse.parseGpx(gpxData, (error, data) => {
                    if (error) {
                        log(`Error parsing GPX file: ${error}`, 'error');
                        return;
                    }
                   
                    log('GPX parsed successfully. Drawing path on map.', 'success');
                   
                    // The parser gives us an array of tracks, each with segments of points.
                    const points = data.tracks[0].segments[0].map(p => [p.lat, p.lon]);
                   
                    // Create a blue line (Polyline) from the points and add it to the map.
                    swcpPolyline = L.polyline(points, { color: 'blue', weight: 3 }).addTo(map);
                   
                    // Zoom the map to fit the entire path.
                    map.fitBounds(swcpPolyline.getBounds());
                });

            } catch(e) {
                log(`Failed to fetch SWCP GPX file: ${e.message}`, 'error');
            }
        }
       
        // --- Placeholder for Phase 3 ---
        analyzeButton.addEventListener('click', () => {
            log('Analysis started. Fetching your Strava activities...');
            // In the next phase, this function will fetch activities from Strava,
            // get the GPX for each one, and compare it to the 'swcpPolyline' on the map.
            alert("Activity analysis is part of the next phase. For now, we've successfully connected to Strava and drawn the path!");
            fetchActivities();
        });

        async function fetchActivities() {
            const accessToken = sessionStorage.getItem('stravaAccessToken');
            if (!accessToken) {
                log('Not connected to Strava.', 'error');
                return;
            }

            try {
                // We'll fetch the last 30 activities as a test.
                const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=30`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const activities = await response.json();
                if (response.ok) {
                    log(`Successfully fetched ${activities.length} activities.`, 'success');
                    // We will only look at Walks and Hikes
                    const walks = activities.filter(a => ['Walk', 'Hike'].includes(a.type));
                    log(`Found ${walks.length} walks/hikes. Check the browser console (F12) to see them.`);
                    console.log('Walks/Hikes found:', walks);
                } else {
                    log(`Error fetching activities: ${activities.message}`, 'error');
                }
            } catch(e) {
                log(`A network error occurred while fetching activities: ${e.message}`, 'error');
            }
        }

    </script>
</body>
</html>
