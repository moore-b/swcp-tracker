<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWCP Tracker</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Basic styling for demonstration purposes */
        body { font-family: sans-serif; margin: 20px; }
        #login-container { max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #app-content { display: none; padding: 20px; border: 1px solid #eee; border-radius: 8px; margin-top: 20px; }
        input[type="text"], input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #fc4c02; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #e54400; }
        #loading-message { display: none; margin-top: 20px; font-weight: bold; }
        #activity-data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #activity-data-table th, #activity-data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #activity-data-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div id="login-container">
        <h2>Strava SWCP Tracker Login</h2>
        <p>Please enter your Strava API Client ID and Client Secret.</p>
        <label for="clientIdInput">Client ID:</label><br>
        <input type="text" id="clientIdInput" placeholder="Enter Strava Client ID"><br>
        <label for="clientSecretInput">Client Secret:</label><br>
        <input type="password" id="clientSecretInput" placeholder="Enter Strava Client Secret"><br>
        <button id="loginButton">Login with Strava</button>
        <p><small>Your Client ID and Secret are stored locally in your browser and not sent to any server other than Strava's.</small></p>
    </div>

    <div id="app-content">
        <h2>SWCP Tracker Dashboard</h2>
        <p>Welcome, Strava Athlete! Fetching your activities...</p>
        <div id="loading-message">Loading activities... This may take a moment.</div>
        <table id="activity-data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Distance (km)</th>
                    <th>Elevation (m)</th>
                    <th>Moving Time</th>
                    <th>SWCP Status</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <button id="logoutButton">Logout</button>
    </div>

    <script>
        const loginContainer = document.getElementById('login-container');
        const appContent = document.getElementById('app-content');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const clientIdInput = document.getElementById('clientIdInput');
        const clientSecretInput = document.getElementById('clientSecretInput');
        const loadingMessage = document.getElementById('loading-message');
        const activityDataTableBody = document.querySelector('#activity-data-table tbody');

        let analysisWorker; // Declare the worker globally

        function showLoginScreen() {
            loginContainer.style.display = 'block';
            appContent.style.display = 'none';
            // Pre-fill from localStorage if available
            clientIdInput.value = localStorage.getItem('stravaClientId') || '';
            clientSecretInput.value = localStorage.getItem('stravaClientSecret') || '';
        }

        function hideLoginAndShowContent() {
            loginContainer.style.display = 'none';
            appContent.style.display = 'block';
        }

        async function handleStravaLogin() {
            const clientId = clientIdInput.value.trim();
            const clientSecret = clientSecretInput.value.trim();

            if (!clientId || !clientSecret) {
                alert('Please enter both Client ID and Client Secret.');
                return;
            }

            localStorage.setItem('stravaClientId', clientId);
            localStorage.setItem('stravaClientSecret', clientSecret);

            const redirectUri = window.location.origin; // e.g., https://swcp-tracker.onrender.com
            const stravaAuthUrl = `https://www.strava.com/oauth/authorize?` +
                `client_id=${clientId}&` +
                `response_type=code&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `approval_prompt=auto&` + // Changed to 'auto' for smoother UX after first time
                `scope=activity:read_all,profile:read_all`; // Request all necessary scopes

            window.location.href = stravaAuthUrl;
        }

        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('stravaRefreshToken');
            const clientId = localStorage.getItem('stravaClientId');
            const clientSecret = localStorage.getItem('stravaClientSecret');

            if (!refreshToken || !clientId || !clientSecret) {
                console.error('Missing refresh token or client credentials for refresh.');
                // Force re-login if refresh token or credentials are missing
                alert('Session expired or incomplete. Please log in again.');
                handleLogout();
                return null;
            }

            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded' // Corrected Content-Type
                    },
                    body: new URLSearchParams({ // Corrected body format
                        client_id: clientId,
                        client_secret: clientSecret,
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken
                    }).toString()
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to refresh token:', response.status, errorData);
                    alert(`Failed to refresh token: ${errorData.message || 'Unknown error'}. Please log in again.`);
                    handleLogout(); // Force re-login on refresh failure
                    return null;
                }

                const data = await response.json();
                console.log('Token refresh successful:', data);

                localStorage.setItem('stravaAccessToken', data.access_token);
                localStorage.setItem('stravaRefreshToken', data.refresh_token); // Refresh token might change
                localStorage.setItem('stravaExpiresAt', data.expires_at);
                return data.access_token;

            } catch (error) {
                console.error('Error during token refresh:', error);
                alert('An unexpected error occurred during token refresh. Please log in again.');
                handleLogout();
                return null;
            }
        }

        async function getAccessToken() {
            let accessToken = localStorage.getItem('stravaAccessToken');
            const expiresAt = localStorage.getItem('stravaExpiresAt');

            // Check if token is expired (giving a small buffer)
            if (!accessToken || !expiresAt || Date.now() / 1000 >= parseInt(expiresAt, 10) - 300) { // 5-min buffer
                console.log('Access token expired or missing, attempting to refresh...');
                accessToken = await refreshAccessToken();
            }
            return accessToken;
        }

        async function fetchAndProcessActivities() {
            loadingMessage.style.display = 'block';
            activityDataTableBody.innerHTML = ''; // Clear previous data

            const accessToken = await getAccessToken();
            if (!accessToken) {
                console.error('No valid access token available.');
                loadingMessage.textContent = 'Failed to load activities: Authentication required.';
                return;
            }

            const athleteId = localStorage.getItem('athleteId');
            if (!athleteId) {
                console.error('Athlete ID not found.');
                loadingMessage.textContent = 'Failed to load activities: Athlete ID missing.';
                return;
            }

            try {
                const activities = [];
                let page = 1;
                const perPage = 200; // Max per page
                let hasMore = true;

                while (hasMore) {
                    const response = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=${perPage}&page=${page}`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 401) {
                            console.error('Unauthorized access. Token might be invalid or expired. Attempting refresh...');
                            // This case should ideally be caught by getAccessToken, but as a fallback
                            const newAccessToken = await refreshAccessToken();
                            if (newAccessToken) {
                                // Retry the fetch with the new token
                                const retryResponse = await fetch(`https://www.strava.com/api/v3/athlete/activities?per_page=${perPage}&page=${page}`, {
                                    headers: { 'Authorization': `Bearer ${newAccessToken}` }
                                });
                                if (retryResponse.ok) {
                                    const pageActivities = await retryResponse.json();
                                    activities.push(...pageActivities);
                                    hasMore = pageActivities.length === perPage;
                                    page++;
                                    continue; // Continue the loop with the next page
                                } else {
                                    console.error('Retry with new token failed:', retryResponse.status, await retryResponse.json());
                                    alert('Failed to load activities after token refresh. Please log in again.');
                                    handleLogout();
                                    return;
                                }
                            } else {
                                console.error('Could not refresh token for activity fetch. Re-authentication required.');
                                alert('Could not refresh token. Please log in again.');
                                handleLogout();
                                return;
                            }
                        } else {
                            console.error('Failed to fetch activities:', response.status, errorData);
                            alert(`Failed to fetch activities: ${errorData.message || 'Unknown error'}.`);
                            loadingMessage.textContent = 'Error loading activities.';
                            return;
                        }
                    }

                    const pageActivities = await response.json();
                    activities.push(...pageActivities);
                    hasMore = pageActivities.length === perPage; // Continue if we got max activities
                    page++;
                }

                console.log(`Fetched ${activities.length} activities.`);
                loadingMessage.textContent = `Processing ${activities.length} activities...`;

                // Initialize Web Worker if not already
                if (!analysisWorker) {
                    analysisWorker = new Worker('swcp_analysis_worker.js'); // Corrected worker filename
                }

                analysisWorker.onmessage = function(event) {
                    if (event.data.type === 'progress') {
                        loadingMessage.textContent = `Processing activities: ${event.data.message}`;
                    } else if (event.data.type === 'result') {
                        const { activities: processedActivities, totalDistance, totalElevation, totalMovingTime, swcpStatus } = event.data.payload;
                        displayActivities(processedActivities);
                        // You can display totalDistance etc. in your UI here
                        console.log('Analysis complete. Total SWCP distance:', totalDistance, 'km');
                        console.log('SWCP Status:', swcpStatus);
                        loadingMessage.style.display = 'none'; // Hide loading message
                    }
                };

                analysisWorker.onerror = function(error) {
                    console.error('Web Worker error:', error);
                    alert('An error occurred during activity analysis. See console for details.');
                    loadingMessage.style.display = 'none';
                };

                analysisWorker.postMessage({ type: 'processActivities', activities: activities });

            } catch (error) {
                console.error('Error fetching or processing activities:', error);
                alert('An unexpected error occurred while fetching activities. Please try again.');
                loadingMessage.style.display = 'none';
            }
        }

        function displayActivities(activities) {
            activityDataTableBody.innerHTML = ''; // Clear table before adding new data
            activities.forEach(activity => {
                const row = activityDataTableBody.insertRow();
                row.insertCell().textContent = new Date(activity.start_date_local).toLocaleDateString();
                row.insertCell().textContent = activity.name;
                row.insertCell().textContent = activity.type;
                row.insertCell().textContent = (activity.distance / 1000).toFixed(2); // meters to km
                row.insertCell().textContent = activity.total_elevation_gain.toFixed(0); // meters
                row.insertCell().textContent = formatTime(activity.moving_time); // seconds to HH:MM:SS
                row.insertCell().textContent = activity.swcpStatus;
            });
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return [h, m, s]
                .map(v => v < 10 ? '0' + v : v)
                .filter((v, i) => v !== '00' || i > 0)
                .join(':');
        }

        function handleLogout() {
            localStorage.removeItem('stravaAccessToken');
            localStorage.removeItem('stravaRefreshToken');
            localStorage.removeItem('stravaExpiresAt');
            localStorage.removeItem('athleteId');
            localStorage.removeItem('stravaClientId'); // Clear saved client ID
            localStorage.removeItem('stravaClientSecret'); // Clear saved client Secret
            showLoginScreen();
            activityDataTableBody.innerHTML = ''; // Clear table
            loadingMessage.style.display = 'none'; // Hide loading message
        }

        // Event Listeners
        loginButton.addEventListener('click', handleStravaLogin);
        logoutButton.addEventListener('click', handleLogout);

        // Initial check on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                // If there's a code, it means we just came back from Strava auth
                handleStravaCallback();
            } else {
                // Otherwise, check if we're already logged in (have access token)
                const accessToken = localStorage.getItem('stravaAccessToken');
                if (accessToken) {
                    hideLoginAndShowContent();
                    fetchAndProcessActivities();
                } else {
                    showLoginScreen();
                }
            }
        });
    </script>
</body>
</html>
